#!/usr/bin/env node

/**
 * Clones several projects that are known to follow "JavaScript Standard Style" and runs
 * the `standard` style checker to verify that it passes without warnings. This helps
 * ensure we don't accidentally introduce new style rules that cause previously "good"
 * code to start failing with new warnings! (And if we do, then that needs to be a MAJOR
 * VERSION BUMP.)
 */

var cp = require('child_process')
var extend = require('xtend')
var mkdirp = require('mkdirp')
var path = require('path')
var rimraf = require('rimraf')
var series = require('run-series')
var test = require('tape')

var TMP = path.join(__dirname, '..', 'tmp')
var SEMISTANDARD = path.join(__dirname, '..', 'bin', 'cmd.js')

var URLS = [
  /*
  'https://github.com/blinkmobile/varied-definition.js',
  'https://github.com/Flet/acetate',
  'https://github.com/Flet/cursorfun',
  'https://github.com/Flet/scenevr',
  'https://github.com/icyflame/convert-angle',
  'https://github.com/icyflame/generator-nm-semistandard',
  'https://github.com/icyflame/get-hosts-cli',
  'https://github.com/icyflame/get-numbers',
  'https://github.com/icyflame/remove-min-max',
  'https://github.com/JGAntunes/ampersand-infinite-scroll',
  'https://github.com/JGAntunes/ampersand-pagination-mixin',
  'https://github.com/larsthorup/amaze',
  'https://github.com/larsthorup/neo4j-sandbox',
  'https://github.com/scenevr/summary',
  'https://github.com/shama/webpack-stream',
  'https://github.com/spudly/error-subclass',
  'https://github.com/spudly/error-wrapper',
  'https://github.com/developmentseed/project-seed',
  'https://github.com/hotosm/oam-catalog',
  'https://github.com/bnolan/kollection'
  */
  'https://github.com/ampedandwired/html-webpack-plugin',
  'https://github.com/shama/webpack-stream',
  'https://github.com/blakeembrey/pluralize',
  'https://github.com/shama/gaze',
  'https://github.com/google/google-api-nodejs-client',
  'https://github.com/indutny/bn.js',
  'https://github.com/tomusdrw/grunt-sync',
  'https://github.com/aframevr/aframe',
  'https://github.com/jonschlinkert/window-size',
  'https://github.com/kesla/node-snappy',
  'https://github.com/Hypercubed/autocmdr',
  'https://github.com/pwmckenna/node-travis-encrypt',
  'https://github.com/scijs/ndarray-blas-level1',
  'https://github.com/speakeasyjs/speakeasy',
  'https://github.com/mapbox/wellknown',
  'https://github.com/mattdesl/touch-position',
  'https://github.com/aframevr/aframe-core',
  'https://github.com/brandonhorst/node-osa',
  'https://github.com/Esri/esri-leaflet',
  'https://github.com/gabmontes/tiny-promisify',
  'https://github.com/AlexeyGorokhov/ag-module-builder',
  'https://github.com/AlexeyGorokhov/stylesheet-injector',
  'https://github.com/AlexeyGorokhov/delegate-normalizer',
  'https://github.com/numo-labs/aws-lambda-deploy',
  'https://github.com/ricardofbarros/semistandard-format',
  'https://github.com/Jam3/gl-shader-output',
  'https://github.com/Jam3/devtool',
  'https://github.com/cliftonc/seguir',
  'https://github.com/micnews/query-dom',
  'https://github.com/wbinnssmith/arraybuffer-equal',
  'https://github.com/esri/arcgis-to-geojson',
  'https://github.com/jstransformers/inputformat-to-jstransformer',
  'https://github.com/thebergamo/k7',
  'https://github.com/tangledfruit/rx-to-async-iterator',
  'https://github.com/janpot/fantastiq',
  'https://github.com/rstacruz/dom101',
  'https://github.com/wombleton/semistandard-loader',
  'https://github.com/bithound/cli.bithound.io',
  'https://github.com/Hypercubed/mini-signals',
  'https://github.com/sotojuan/nani',
  'https://github.com/micnews/embedly-url',
  'https://github.com/anarh/node-sass-import',
  'https://github.com/hugowetterberg/obpath.js',
  'https://github.com/mattdesl/urify',
  'https://github.com/spudly/error-subclass',
  'https://github.com/hudson-taylor/utils',
  'https://github.com/Roilan/mailchimpify',
  'https://github.com/zetlen/clortho',
  'https://github.com/jsfr/grunt-semistandard',
  'https://github.com/chrisinajar/american-sounding-names',
  'https://github.com/scijs/ndarray-blas-level2',
  'https://github.com/neurotech/node-edumate',
  'https://github.com/chrisinajar/has-chrome-storage',
  'https://github.com/hotosm/oam-browser-filters',
  'https://github.com/wKovacs64/hibp',
  'https://github.com/hudson-taylor/http-transport',
  'https://github.com/hudson-taylor/tcp-transport',
  'https://github.com/wbinnssmith/promise-try',
  'https://github.com/sotojuan/anicollage',
  'https://github.com/icyflame/remove-min-max',
  'https://github.com/tangledfruit/rx-fetch',
  'https://github.com/micnews/html-to-article-json',
  'https://github.com/tangledfruit/rxjs-to-async-iterator',
  'https://github.com/scenevr/server',
  'https://github.com/numical/script-ext-html-webpack-plugin',
  'https://github.com/jantimon/html-webpack-harddisk-plugin',
  'https://github.com/AlexeyGorokhov/directory-files',
  'https://github.com/micnews/hyperfast',
  'https://github.com/nekuz0r/smart-bucket',
  'https://github.com/micnews/apple-news',
  'https://github.com/scijs/integrate-adaptive-simpson',
  'https://github.com/numical/style-ext-html-webpack-plugin',
  'https://github.com/jsreport/jsreport-fs-store',
  'https://github.com/Hypercubed/svgsaver',
  'https://github.com/devTristan/tagged-template-escape',
  'https://github.com/AlexeyGorokhov/templator',
  'https://github.com/patrickarlt/tiny-binary-search',
  'https://github.com/patrickarlt/acetate',
  'https://github.com/icyflame/gh-gist-owner',
  'https://github.com/Esri/Leaflet.shapeMarkers',
  'https://github.com/CartoDB/turbo-carto',
  'https://github.com/patrickarlt/leaflet-virtual-grid',
  'https://github.com/micnews/walk-apple-news-format',
  'https://github.com/jantimon/webpack-recompilation-simulator',
  'https://github.com/sotojuan/wwwtxt',
  'https://github.com/chrisinajar/main-loop-app',
  'https://github.com/icyflame/math-sort',
  'https://github.com/jsreport/jsreport-static-resources',
  'https://github.com/icyflame/gh-repos-creation-cal',
  'https://github.com/icyflame/gh-username-available',
  'https://github.com/numo-labs/aws-lambda-canary',
  'https://github.com/muzzley/good-bunyan',
  'https://github.com/ricardofbarros/battleship-game',
  'https://github.com/bb-ffbb/bbffbb-scraper',
  'https://github.com/marvinroger/node-binary-file',
  'https://github.com/nebez/gulp-semistandard',
  'https://github.com/continuationlabs/hapi-setup',
  'https://github.com/sotojuan/bitcly',
  'https://github.com/raiseandfall/hash.subscribe',
  'https://github.com/ethers/bitcoin-proof',
  'https://github.com/lovell/highwayhash',
  'https://github.com/chrisinajar/anchor-pushstate',
  'https://github.com/Hypercubed/angular-downloadsvg-directive',
  'https://github.com/Jam3/brfs-babel',
  'https://github.com/micnews/html-to-amp',
  'https://github.com/CartoDB/deep-insights.js',
  'https://github.com/garth/cerebral-modules',
  'https://github.com/icyflame/check-pnr-status',
  'https://github.com/icyflame/cli-strlen',
  'https://github.com/nekuz0r/i18next-smart-bucket-backend',
  'https://github.com/lw7360/imburr',
  'https://github.com/micnews/immutable-object-methods',
  'https://github.com/edenspiekermann/a11y-toggle',
  'https://github.com/voxpelli/node-installed-check',
  'https://github.com/nearform/cloudwatchlogs-stream',
  'https://github.com/chrisinajar/invoke-handler',
  'https://github.com/icyflame/is-hexdigest',
  'https://github.com/numo-labs/isearch-ui',
  'https://github.com/kesla/jade-to-handlebars',
  'https://github.com/thebergamo/joi18nz',
  'https://github.com/RobLoach/jquery-once',
  'https://github.com/chrisinajar/json-stylesheets',
  'https://github.com/chrisinajar/collect-methods',
  'https://github.com/chrisinajar/config-request',
  'https://github.com/AlexeyGorokhov/jwt-identity',
  'https://github.com/jstransformers/consolidate-jstransformer',
  'https://github.com/thebergamo/k7-mongoose',
  'https://github.com/thebergamo/k7-sequelize',
  'https://github.com/eHealthAfrica/kazana-email-box',
  'https://github.com/micnews/lambda-manager',
  'https://github.com/numo-labs/lambda-ne-classic-package-provider',
  'https://github.com/numo-labs/lambda-taggable-elasticsearch-indexer',
  'https://github.com/numo-labs/lambda-taggable-geonames-indexer',
  'https://github.com/numo-labs/lambda-taggable-s3-event-listener',
  'https://github.com/micnews/contenteditable-placeholder',
  'https://github.com/icyflame/convert-angle',
  'https://github.com/micnews/levelgraph-query',
  'https://github.com/therebelrobot/maelman',
  'https://github.com/micnews/courier',
  'https://github.com/zetlen/creosote',
  'https://github.com/warbrett/node-cronofy',
  'https://github.com/icyflame/metakgp-visualize-cli',
  'https://github.com/kalamuna/metalsmith-env',
  'https://github.com/RobLoach/metalsmith-feedparser',
  'https://github.com/jantimon/css-sourcemaps-webpack-plugin',
  'https://github.com/shyiko/node-minimal-viable-pool',
  'https://github.com/scijs/minimize-golden-section-1d',
  'https://github.com/modern-standard/ide-plugin-atom',
  'https://github.com/rasmuserik/mubackend',
  'https://github.com/icyflame/cstimer-txt-to-json',
  'https://github.com/sotojuan/nani-cli',
  'https://github.com/RobLoach/nconf-toml',
  'https://github.com/patrickarlt/custom-element-decorators',
  'https://github.com/nexusdev/dapple',
  'https://github.com/scijs/ndarray-givens-qr',
  'https://github.com/chrisinajar/not-mercury',
  'https://github.com/sotojuan/anicollage-cli',
  'https://github.com/anarh/demo-scss-npm-module',
  'https://github.com/anarh/node-sass-import-example',
  'https://github.com/chrisinajar/not-mercury',
  'https://github.com/chrisinajar/any-storage',
  'https://github.com/AlexeyGorokhov/ag-project-builder',
  'https://github.com/chrisinajar/orderbook-calculation',
  'https://github.com/joesonw/webpack-stream',
  'https://github.com/icyflame/partition-into',
  'https://github.com/lovell/petra',
  'https://github.com/docusign/docusign-node-client',
  'https://github.com/wbinnssmith/promise-method',
  'https://github.com/docusign/docusign-node-client',
  'https://github.com/sotojuan/puns',
  'https://github.com/wKovacs64/pwned',
  'https://github.com/micnews/dom-to-vdom',
  'https://github.com/rstacruz/ractive-ractive',
  'https://github.com/rreusser/react-native-paged-scroll-view',
  'https://github.com/nowsecure/node-applesign',
  'https://github.com/larsthorup/node-request-har-capture',
  'https://github.com/tangledfruit/rx-couch',
  'https://github.com/SoullessWaffle/dotifier',
  'https://github.com/patrickarlt/acetate-asset-revisions',
  'https://github.com/tangledfruit/rxjs-fetch',
  'https://github.com/shyiko/electron-har',
  'https://github.com/antirek/ryocdr',
  'https://github.com/micnews/s3-diff',
  'https://github.com/Sagacify/logger',
  'https://github.com/micnews/save-selection',
  'https://github.com/geowarin/electron-hot-loader',
  'https://github.com/scenevr/summary',
  'https://github.com/scenevr/server',
  'https://github.com/scenevr/summary',
  'https://github.com/mattdesl/scrape-scripts',
  'https://github.com/micnews/array-merge-equal',
  'https://github.com/micnews/seamless-immutable-diff',
  'https://github.com/sotojuan/sec-to-min',
  'https://github.com/MyPureCloud/ember-webrtc-devices',
  'https://github.com/cliftonc/seguir-express-middleware',
  'https://github.com/cliftonc/seguir-notify',
  'https://github.com/cliftonc/seguir',
  'https://github.com/tes/seguir-worker',
  'https://github.com/MyPureCloud/ember-webrtc-troubleshoot',
  'https://github.com/JGAntunes/ampersand-infinite-scroll',
  'https://github.com/AlexeyGorokhov/server-error-handler',
  'https://github.com/larsthorup/node-sheet-reader',
  'https://github.com/JamieMason/shrinkpack',
  'https://github.com/larsthorup/sinon-har-server',
  'https://github.com/raiseandfall/slugify-files',
  'https://github.com/spudly/error-wrapper',
  'https://github.com/wbinnssmith/smear',
  'https://github.com/micnews/article-json-to-apple-news',
  'https://github.com/Woorank/social-url',
  'https://github.com/spacekit/spacekit',
  'https://github.com/spacekit/spacekit-service',
  'https://github.com/Esri/esri-leaflet-clustered-feature-layer',
  'https://github.com/numo-labs/spies-url-parser',
  'https://github.com/Woorank/structured-logging',
  'https://github.com/Esri/esri-leaflet-geocoder',
  'https://github.com/jgravois/esri-leaflet-gp',
  'https://github.com/mathisonian/svg-filter',
  'https://github.com/Esri/esri-leaflet-heatmap-feature-layer',
  'https://github.com/numo-labs/lambda-taggable-geonames-indexer',
  'https://github.com/numo-labs/taggable-searcher',
  'https://github.com/jgravois/esri-leaflet-related',
  'https://github.com/kesla/tapava',
  'https://github.com/giano/Telegrammer',
  'https://github.com/Esri/esri-leaflet-renderers',
  'https://github.com/icyflame/terminal-wallet',
  'https://github.com/mattdesl/three-line-2d',
  'https://github.com/goldylucks/eth-git-flow',
  'https://github.com/micnews/execute-scripts',
  'https://github.com/Hypercubed/todo-md',
  'https://github.com/lw7360/asciiartfarts',
  'https://github.com/sotojuan/trashss',
  'https://github.com/edenspiekermann/faster-react-tabs',
  'https://github.com/jantimon/favicons-webpack-plugin',
  'https://github.com/CartoDB/turbo-cartocss',
  'https://github.com/AlexeyGorokhov/ui-lang-detector',
  'https://github.com/javiercejudo/is-sorted',
  'https://github.com/mkopit/url-embed',
  'https://github.com/micnews/validate-inline-js',
  'https://github.com/JGAntunes/ampersand-pagination-mixin',
  'https://github.com/Hypercubed/wc.js',
  'https://github.com/chrisinajar/weakmap-animation',
  'https://github.com/OpenGov/geocsv',
  'https://github.com/mapbox/get-control-points',
  'https://github.com/icyflame/get-hosts-cli',
  'https://github.com/icyflame/get-numbers',
  'https://github.com/sotojuan/tapes',
  'https://github.com/muzzley/zmq-pool',
  'https://github.com/sotojuan/zwwwtxt'
]

var MODULES = {}
URLS.forEach(function (url) {
  var spliturl = url.split('/')
  var name = spliturl[spliturl.length - 1]
  MODULES[name] = url + '.git'
})

test('clone repos from github', function (t) {
  t.plan(1)
  rimraf.sync(TMP)
  mkdirp.sync(TMP)

  series(Object.keys(MODULES).map(function (name) {
    var url = MODULES[name]
    return function (cb) {
      var args = [ 'clone', '--depth', 1, url, path.join(TMP, name) ]
      // TODO: Start `git` in a way that works on Windows â€“ PR welcome!
      spawn('git', args, {}, cb)
    }
  }), function (err) {
    if (err) throw err
    t.pass('cloned repos')
  })
})

test('lint repos', function (t) {
  t.plan(URLS.length)
  series(Object.keys(MODULES).map(function (name) {
    return function (cb) {
      var cwd = path.join(TMP, name)
      spawn(SEMISTANDARD, [], { cwd: cwd }, function (err) {
        t.error(err, name)
        cb(null)
      })
    }
  }))
})

function spawn (command, args, opts, cb) {
  var child = cp.spawn(command, args, extend({ stdio: 'inherit' }, opts))
  child.on('error', cb)
  child.on('close', function (code) {
    if (code !== 0) cb(new Error('non-zero exit code: ' + code))
    else cb(null)
  })
  return child
}
